<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Analytics Real Data Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .test-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .test-section h3 {
            margin: 0 0 15px 0;
            color: #fbbf24;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        button:hover { 
            background: #2563eb; 
            transform: translateY(-1px);
        }
        
        button:disabled { 
            background: #6b7280; 
            cursor: not-allowed; 
            transform: none;
        }
        
        button.success { background: #10b981; }
        button.success:hover { background: #059669; }
        
        button.warning { background: #f59e0b; }
        button.warning:hover { background: #d97706; }
        
        button.danger { background: #ef4444; }
        button.danger:hover { background: #dc2626; }
        
        .status {
            padding: 12px;
            margin: 10px 0;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .status.success { 
            background: rgba(16, 185, 129, 0.2); 
            border: 1px solid #10b981; 
            color: #10b981;
        }
        
        .status.error { 
            background: rgba(239, 68, 68, 0.2); 
            border: 1px solid #ef4444; 
            color: #ef4444;
        }
        
        .status.warning { 
            background: rgba(245, 158, 11, 0.2); 
            border: 1px solid #f59e0b; 
            color: #f59e0b;
        }
        
        .status.info { 
            background: rgba(59, 130, 246, 0.2); 
            border: 1px solid #3b82f6; 
            color: #60a5fa;
        }
        
        .data-display {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .metric-card {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .metric-label {
            font-size: 12px;
            opacity: 0.7;
        }
        
        .validation-results {
            margin-top: 20px;
        }
        
        .validation-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            margin: 5px 0;
            border-radius: 6px;
            border-left: 4px solid transparent;
        }
        
        .validation-item.real {
            border-left-color: #10b981;
        }
        
        .validation-item.fake {
            border-left-color: #ef4444;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: #10b981;
            transition: width 0.5s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Complete Analytics Real Data Validation</h1>
            <p>Comprehensive testing to ensure all analytics data comes from real user activity</p>
        </div>

        <div class="test-grid">
            <!-- System Initialization -->
            <div class="test-section">
                <h3>üöÄ System Initialization</h3>
                <div class="button-group">
                    <button onclick="initializeSystem()">Initialize Analytics</button>
                    <button onclick="clearAllData()" class="danger">Clear All Data</button>
                </div>
                <div id="init-status" class="status info">
                    Ready to initialize analytics system
                </div>
            </div>

            <!-- Data Simulation -->
            <div class="test-section">
                <h3>üìö Data Simulation</h3>
                <div class="button-group">
                    <button onclick="addVocabularyData()">Add Vocabulary</button>
                    <button onclick="simulateReviewSession()" class="success">Simulate Reviews</button>
                    <button onclick="simulateMultipleSessions()" class="success">Multiple Sessions</button>
                </div>
                <div id="simulation-status" class="status info">
                    Ready to simulate user activity
                </div>
            </div>

            <!-- Real Data Validation -->
            <div class="test-section">
                <h3>‚úÖ Data Validation</h3>
                <div class="button-group">
                    <button onclick="validateAllData()" class="warning">Validate All</button>
                    <button onclick="checkForHardcodedValues()">Check Hardcoded</button>
                    <button onclick="generateValidationReport()">Full Report</button>
                </div>
                <div id="validation-status" class="status info">
                    Ready to validate data authenticity
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="validation-progress" style="width: 0%"></div>
                </div>
            </div>

            <!-- Analytics Dashboard Test -->
            <div class="test-section">
                <h3>üìä Dashboard Test</h3>
                <div class="button-group">
                    <button onclick="testDashboardStats()">Get Dashboard Stats</button>
                    <button onclick="testLearningPatterns()">Test Learning Patterns</button>
                    <button onclick="openActualDashboard()">Open Real Dashboard</button>
                </div>
                <div id="dashboard-status" class="status info">
                    Ready to test dashboard components
                </div>
            </div>
        </div>

        <!-- Current Metrics Display -->
        <div class="test-section">
            <h3>üìà Current Analytics Metrics</h3>
            <div class="metrics-grid" id="metrics-grid">
                <div class="metric-card">
                    <div class="metric-value" id="metric-total-words">0</div>
                    <div class="metric-label">Total Words Learned</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="metric-current-streak">0</div>
                    <div class="metric-label">Current Streak</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="metric-time-spent">0m</div>
                    <div class="metric-label">Time Spent Learning</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="metric-today-accuracy">0%</div>
                    <div class="metric-label">Today's Accuracy</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="metric-total-xp">0</div>
                    <div class="metric-label">Total XP</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="metric-total-sessions">0</div>
                    <div class="metric-label">Total Sessions</div>
                </div>
            </div>
        </div>

        <!-- Data Display -->
        <div class="test-section">
            <h3>üîç Raw Data Inspection</h3>
            <div class="button-group">
                <button onclick="showRawAnalyticsData()">Raw Analytics</button>
                <button onclick="showStorageContents()">Storage Contents</button>
                <button onclick="showProcessedStats()">Processed Stats</button>
            </div>
            <div id="data-display" class="data-display">
                Raw data will appear here...
            </div>
        </div>

        <!-- Validation Results -->
        <div class="test-section validation-results">
            <h3>üéØ Validation Results</h3>
            <div id="validation-results">
                Run validation to see results...
            </div>
        </div>

        <!-- Activity Log -->
        <div class="test-section">
            <h3>üìù Activity Log</h3>
            <div id="activity-log" class="data-display" style="max-height: 200px;">
                Activity log will appear here...
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="src/analytics.js"></script>
    <script src="src/ui/analytics.js"></script>
    <script src="validate-real-data.js"></script>
    <script>
        // Chrome Storage Mock
        window.chrome = {
            storage: {
                local: {
                    data: {},
                    get(keys, callback) {
                        const result = {};
                        if (keys === null) {
                            callback(this.data);
                            return;
                        }
                        if (typeof keys === 'string') keys = [keys];
                        keys.forEach(key => {
                            if (this.data[key]) {
                                result[key] = JSON.parse(JSON.stringify(this.data[key]));
                            }
                        });
                        setTimeout(() => callback(result), 10);
                    },
                    set(data, callback) {
                        Object.assign(this.data, data);
                        if (callback) setTimeout(callback, 10);
                    },
                    clear(callback) {
                        this.data = {};
                        if (callback) setTimeout(callback, 10);
                    }
                }
            }
        };

        let analytics = null;
        let sessionCount = 0;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('activity-log');
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}]`, message);
        }

        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }

        function updateMetrics(stats) {
            document.getElementById('metric-total-words').textContent = stats.totalWordsLearned || 0;
            document.getElementById('metric-current-streak').textContent = `${stats.currentStreak || 0} days`;
            document.getElementById('metric-time-spent').textContent = `${stats.totalTime || 0}m`;
            document.getElementById('metric-today-accuracy').textContent = `${stats.todayAccuracy || 0}%`;
            document.getElementById('metric-total-xp').textContent = stats.totalXP || 0;
            document.getElementById('metric-total-sessions').textContent = stats.totalSessions || 0;
        }

        async function initializeSystem() {
            try {
                log('üöÄ Initializing analytics system...');
                updateStatus('init-status', 'Initializing...', 'info');
                
                analytics = new VocabAnalytics();
                await analytics.ensureInitialized();
                
                updateStatus('init-status', '‚úÖ Analytics system initialized successfully', 'success');
                log('‚úÖ Analytics system ready');
                
                // Update initial metrics
                const stats = await analytics.getDashboardStats();
                updateMetrics(stats);
                
            } catch (error) {
                log(`‚ùå Initialization failed: ${error.message}`, 'error');
                updateStatus('init-status', `‚ùå Initialization failed: ${error.message}`, 'error');
            }
        }

        async function addVocabularyData() {
            const words = [
                { id: 'word_1', word: 'Hello', definition: 'A greeting' },
                { id: 'word_2', word: 'World', definition: 'The earth' },
                { id: 'word_3', word: 'Computer', definition: 'Electronic device' },
                { id: 'word_4', word: 'Programming', definition: 'Writing code' },
                { id: 'word_5', word: 'Algorithm', definition: 'Problem-solving steps' },
                { id: 'word_6', word: 'Variable', definition: 'Data storage' },
                { id: 'word_7', word: 'Function', definition: 'Reusable code block' },
                { id: 'word_8', word: 'Array', definition: 'List of items' }
            ];

            chrome.storage.local.set({ vocabWords: words }, () => {
                log(`üìö Added ${words.length} vocabulary words`);
                updateStatus('simulation-status', `‚úÖ Added ${words.length} vocabulary words`, 'success');
            });
        }

        async function simulateReviewSession() {
            if (!analytics) {
                log('‚ö†Ô∏è Analytics not initialized');
                return;
            }

            try {
                sessionCount++;
                log(`üéØ Starting review session #${sessionCount}...`);
                updateStatus('simulation-status', `Starting session #${sessionCount}...`, 'info');

                await analytics.startSession();

                const words = ['hello', 'world', 'computer', 'programming', 'algorithm', 'variable'];
                let correctAnswers = 0;

                for (let i = 0; i < words.length; i++) {
                    const wordId = `word_${i + 1}`;
                    const quality = 3 + Math.floor(Math.random() * 3); // Quality 3-5
                    const timeSpent = 1500 + Math.random() * 3000; // 1.5-4.5 seconds
                    
                    await analytics.recordWordReview(wordId, words[i], words[i], quality, timeSpent);
                    if (quality >= 3) correctAnswers++;
                }

                const summary = await analytics.endSession();
                log(`‚úÖ Session #${sessionCount} completed: ${summary.wordsReviewed} words, ${summary.accuracy.toFixed(1)}% accuracy`);
                
                const stats = await analytics.getDashboardStats();
                updateMetrics(stats);
                
                updateStatus('simulation-status', `‚úÖ Session #${sessionCount} completed successfully`, 'success');

            } catch (error) {
                log(`‚ùå Session simulation failed: ${error.message}`, 'error');
                updateStatus('simulation-status', `‚ùå Session failed: ${error.message}`, 'error');
            }
        }

        async function simulateMultipleSessions() {
            for (let i = 0; i < 3; i++) {
                await simulateReviewSession();
                await new Promise(resolve => setTimeout(resolve, 500)); // Small delay
            }
            log('üéâ Multiple sessions simulation completed');
        }

        async function validateAllData() {
            try {
                log('üîç Running comprehensive data validation...');
                updateStatus('validation-status', 'Validating all data...', 'info');
                
                const result = await validateAllAnalyticsData();
                
                if (result.success) {
                    const realCount = Object.values(result.results).filter(r => r.isReal).length;
                    const totalCount = Object.keys(result.results).length;
                    const percentage = Math.round((realCount / totalCount) * 100);
                    
                    updateProgressBar(percentage);
                    
                    const status = result.allReal ? 'success' : 'warning';
                    const message = `‚úÖ Validation complete: ${realCount}/${totalCount} metrics use real data (${percentage}%)`;
                    
                    updateStatus('validation-status', message, status);
                    log(message);
                    
                    displayValidationResults(result.results);
                } else {
                    updateStatus('validation-status', `‚ùå Validation failed: ${result.error}`, 'error');
                    log(`‚ùå Validation failed: ${result.error}`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå Validation error: ${error.message}`, 'error');
                updateStatus('validation-status', `‚ùå Validation error: ${error.message}`, 'error');
            }
        }

        function updateProgressBar(percentage) {
            document.getElementById('validation-progress').style.width = `${percentage}%`;
        }

        function displayValidationResults(results) {
            const container = document.getElementById('validation-results');
            container.innerHTML = '';
            
            Object.entries(results).forEach(([metric, result]) => {
                const div = document.createElement('div');
                div.className = `validation-item ${result.isReal ? 'real' : 'fake'}`;
                
                const status = result.isReal ? '‚úÖ REAL' : '‚ùå FAKE/HARDCODED';
                const warning = result.warning ? ` ‚ö†Ô∏è ${result.warning}` : '';
                
                div.innerHTML = `
                    <div>
                        <strong>${metric}</strong><br>
                        <small>${result.details}</small>${warning}
                    </div>
                    <div>${status}</div>
                `;
                
                container.appendChild(div);
            });
        }

        async function testDashboardStats() {
            if (!analytics) {
                log('‚ö†Ô∏è Analytics not initialized');
                return;
            }

            try {
                const stats = await analytics.getDashboardStats();
                updateMetrics(stats);
                
                document.getElementById('data-display').textContent = 
                    'DASHBOARD STATS:\n' + JSON.stringify(stats, null, 2);
                
                log('üìä Dashboard stats retrieved and displayed');
                updateStatus('dashboard-status', '‚úÖ Dashboard stats retrieved', 'success');
            } catch (error) {
                log(`‚ùå Failed to get dashboard stats: ${error.message}`, 'error');
                updateStatus('dashboard-status', `‚ùå Dashboard test failed: ${error.message}`, 'error');
            }
        }

        async function showRawAnalyticsData() {
            if (!analytics) {
                log('‚ö†Ô∏è Analytics not initialized');
                return;
            }

            try {
                const rawData = await analytics.getAnalyticsData();
                document.getElementById('data-display').textContent = 
                    'RAW ANALYTICS DATA:\n' + JSON.stringify(rawData, null, 2);
                log('üì¶ Raw analytics data displayed');
            } catch (error) {
                log(`‚ùå Failed to get raw data: ${error.message}`, 'error');
            }
        }

        function showStorageContents() {
            chrome.storage.local.get(null, (data) => {
                document.getElementById('data-display').textContent = 
                    'CHROME STORAGE CONTENTS:\n' + JSON.stringify(data, null, 2);
                log('üóÑÔ∏è Storage contents displayed');
            });
        }

        function clearAllData() {
            chrome.storage.local.clear(() => {
                analytics = null;
                sessionCount = 0;
                updateMetrics({});
                
                log('üóëÔ∏è All data cleared');
                updateStatus('init-status', 'üóëÔ∏è Data cleared - reinitialize to continue', 'warning');
                updateStatus('simulation-status', 'Ready for new simulations', 'info');
                updateStatus('validation-status', 'Ready to validate', 'info');
                updateStatus('dashboard-status', 'Ready to test', 'info');
                
                document.getElementById('data-display').textContent = 'Data cleared...';
                document.getElementById('validation-results').innerHTML = 'Run validation to see results...';
                updateProgressBar(0);
            });
        }

        function openActualDashboard() {
            window.open('src/ui/analytics.html', '_blank');
            log('üöÄ Opened actual analytics dashboard in new tab');
        }

        // Auto-initialize on load
        window.addEventListener('load', () => {
            log('üîç Complete Analytics Real Data Test loaded');
            console.log('üîç Use the UI buttons or run functions directly in console');
        });
    </script>
</body>
</html>
