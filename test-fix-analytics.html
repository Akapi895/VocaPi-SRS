<!DOCTYPE html>
<html>
<head>
    <title>Analytics Test & Fix</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-result { background: #f0f0f0; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .simulate-btn { background: #28a745; }
        .simulate-btn:hover { background: #1e7e34; }
    </style>
</head>
<body>
    <h1>🔧 Analytics Test & Fix</h1>
    
    <div class="test-result info">
        <h3>Debug Steps:</h3>
        <ol>
            <li>Create sample vocabulary data</li>
            <li>Populate analytics from vocabulary</li>
            <li>Test analytics dashboard loading</li>
            <li>Verify all metrics are displayed</li>
        </ol>
    </div>
    
    <div>
        <button onclick="createSampleVocab()" class="simulate-btn">1. Create Sample Vocabulary</button>
        <button onclick="populateAnalytics()">2. Populate Analytics</button>
        <button onclick="testDashboard()">3. Test Dashboard</button>
        <button onclick="openAnalyticsDashboard()">4. Open Analytics</button>
        <button onclick="clearAll()" style="background: #dc3545;">Clear All Data</button>
    </div>
    
    <div id="results"></div>
    
    <script>
        const results = document.getElementById('results');
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
            console.log(message);
        }
        
        // Mock chrome storage for testing
        if (typeof chrome === 'undefined') {
            window.chrome = {
                storage: {
                    local: {
                        data: {},
                        get: function(keys, callback) {
                            const result = {};
                            if (Array.isArray(keys)) {
                                keys.forEach(key => {
                                    result[key] = this.data[key];
                                });
                            } else if (typeof keys === 'object') {
                                Object.keys(keys).forEach(key => {
                                    result[key] = this.data[key] || keys[key];
                                });
                            } else {
                                result[keys] = this.data[keys];
                            }
                            setTimeout(() => callback(result), 10);
                        },
                        set: function(data, callback) {
                            Object.assign(this.data, data);
                            if (callback) setTimeout(callback, 10);
                        },
                        clear: function(callback) {
                            this.data = {};
                            if (callback) setTimeout(callback, 10);
                        }
                    }
                }
            };
        }
        
        async function createSampleVocab() {
            log('Creating sample vocabulary data...', 'info');
            
            const sampleWords = [
                {
                    id: '1',
                    word: 'aberration',
                    meaning: 'a departure from what is normal',
                    pronunciation: '/ˌæbəˈreɪʃən/',
                    difficulty: 4,
                    reviewHistory: [
                        { date: '2025-08-10', quality: 3, interval: 1 },
                        { date: '2025-08-11', quality: 4, interval: 2 }
                    ],
                    createdAt: '2025-08-09',
                    nextReview: '2025-08-13'
                },
                {
                    id: '2',
                    word: 'benevolent',
                    meaning: 'well meaning and kindly',
                    pronunciation: '/bɪˈnevələnt/',
                    difficulty: 3,
                    reviewHistory: [
                        { date: '2025-08-10', quality: 5, interval: 1 },
                        { date: '2025-08-11', quality: 4, interval: 3 }
                    ],
                    createdAt: '2025-08-09',
                    nextReview: '2025-08-14'
                },
                {
                    id: '3',
                    word: 'conundrum',
                    meaning: 'a confusing and difficult problem',
                    pronunciation: '/kəˈnʌndrəm/',
                    difficulty: 2,
                    reviewHistory: [
                        { date: '2025-08-11', quality: 3, interval: 1 }
                    ],
                    createdAt: '2025-08-10',
                    nextReview: '2025-08-12'
                },
                {
                    id: '4',
                    word: 'ephemeral',
                    meaning: 'lasting for a very short time',
                    pronunciation: '/ɪˈfem(ə)rəl/',
                    difficulty: 4,
                    reviewHistory: [
                        { date: '2025-08-11', quality: 2, interval: 1 }
                    ],
                    createdAt: '2025-08-10',
                    nextReview: '2025-08-12'
                },
                {
                    id: '5',
                    word: 'fastidious',
                    meaning: 'very attentive to accuracy and detail',
                    pronunciation: '/faˈstɪdiəs/',
                    difficulty: 3,
                    reviewHistory: [],
                    createdAt: '2025-08-11',
                    nextReview: '2025-08-11'
                }
            ];
            
            return new Promise((resolve) => {
                chrome.storage.local.set({ vocabWords: sampleWords }, () => {
                    log(`✅ Created ${sampleWords.length} sample vocabulary words`, 'success');
                    resolve();
                });
            });
        }
        
        async function populateAnalytics() {
            log('Populating analytics from vocabulary data...', 'info');
            
            try {
                // Check if we have vocab data
                const vocabData = await new Promise(resolve => {
                    chrome.storage.local.get(['vocabWords'], result => {
                        resolve(result.vocabWords || []);
                    });
                });
                
                if (vocabData.length === 0) {
                    log('❌ No vocabulary data found. Run step 1 first.', 'error');
                    return;
                }
                
                log(`Found ${vocabData.length} vocabulary words`, 'info');
                
                // Calculate analytics data
                const today = new Date().toISOString().split('T')[0];
                const reviewedWords = vocabData.filter(word => 
                    word.reviewHistory && word.reviewHistory.length > 0
                );
                
                const analyticsData = {
                    initialized: true,
                    version: '1.0.0',
                    createdAt: new Date().toISOString(),
                    
                    // Main stats
                    totalWordsLearned: vocabData.length,
                    totalReviewSessions: Math.max(1, Math.floor(reviewedWords.length / 2)),
                    totalTimeSpent: reviewedWords.length * 3 + vocabData.length * 1, // 3min per review + 1min per word
                    
                    // Streaks
                    currentStreak: reviewedWords.length > 3 ? Math.floor(reviewedWords.length / 2) : 1,
                    longestStreak: Math.max(3, Math.floor(reviewedWords.length / 1.5)),
                    lastStudyDate: today,
                    
                    // Today's stats
                    dailyStats: {
                        [today]: {
                            wordsReviewed: Math.min(reviewedWords.length, 8),
                            timeSpent: Math.min(reviewedWords.length * 3, 25),
                            sessions: Math.min(Math.floor(reviewedWords.length / 3) + 1, 3),
                            accuracy: 75 + Math.floor(Math.random() * 20)
                        }
                    },
                    
                    // Quality distribution from review history
                    qualityDistribution: { 0: 0, 1: 1, 2: 2, 3: 3, 4: 4, 5: 2 },
                    
                    // Word difficulty tracking
                    wordDifficulty: {},
                    
                    // XP and achievements
                    totalXP: reviewedWords.length * 20 + vocabData.length * 10,
                    achievements: [
                        {
                            id: 'first_word',
                            name: 'First Step',
                            description: 'Added your first word',
                            icon: '📝',
                            xp: 50,
                            unlockedAt: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString()
                        }
                    ],
                    
                    studyTimes: []
                };
                
                // Add word difficulty data
                vocabData.forEach(word => {
                    if (word.reviewHistory && word.reviewHistory.length > 0) {
                        const totalQuality = word.reviewHistory.reduce((sum, review) => sum + review.quality, 0);
                        const avgQuality = totalQuality / word.reviewHistory.length;
                        const successes = word.reviewHistory.filter(r => r.quality >= 3).length;
                        
                        analyticsData.wordDifficulty[word.id] = {
                            attempts: word.reviewHistory.length,
                            successes: successes,
                            totalQuality: totalQuality,
                            avgQuality: avgQuality,
                            lastReview: word.reviewHistory[word.reviewHistory.length - 1].date + 'T12:00:00.000Z'
                        };
                    }
                });
                
                // Add weekly data
                for (let i = 6; i >= 0; i--) {
                    const date = new Date(Date.now() - i * 24 * 60 * 60 * 1000);
                    const dateStr = date.toISOString().split('T')[0];
                    
                    if (!analyticsData.dailyStats[dateStr]) {
                        analyticsData.dailyStats[dateStr] = {
                            wordsReviewed: i === 0 ? analyticsData.dailyStats[today].wordsReviewed : Math.floor(Math.random() * 5) + 1,
                            timeSpent: i === 0 ? analyticsData.dailyStats[today].timeSpent : Math.floor(Math.random() * 10) + 5,
                            sessions: i === 0 ? analyticsData.dailyStats[today].sessions : Math.floor(Math.random() * 2) + 1,
                            accuracy: 70 + Math.floor(Math.random() * 25)
                        };
                    }
                }
                
                return new Promise(resolve => {
                    chrome.storage.local.set({ vocabAnalytics: analyticsData }, () => {
                        log('✅ Analytics data populated successfully!', 'success');
                        log(`📊 Stats: ${analyticsData.totalWordsLearned} words, ${analyticsData.totalReviewSessions} sessions, ${analyticsData.totalTimeSpent}min, ${analyticsData.currentStreak}-day streak`, 'info');
                        resolve();
                    });
                });
                
            } catch (error) {
                log(`❌ Error populating analytics: ${error.message}`, 'error');
            }
        }
        
        async function testDashboard() {
            log('Testing analytics dashboard data...', 'info');
            
            try {
                const analyticsData = await new Promise(resolve => {
                    chrome.storage.local.get(['vocabAnalytics'], result => {
                        resolve(result.vocabAnalytics);
                    });
                });
                
                if (!analyticsData) {
                    log('❌ No analytics data found. Run steps 1-2 first.', 'error');
                    return;
                }
                
                log('✅ Analytics data found!', 'success');
                log(`📈 Total Words: ${analyticsData.totalWordsLearned}`, 'info');
                log(`🔥 Current Streak: ${analyticsData.currentStreak}`, 'info');
                log(`⏱️ Total Time: ${analyticsData.totalTimeSpent} minutes`, 'info');
                log(`🏆 Total XP: ${analyticsData.totalXP}`, 'info');
                log(`🎯 Achievements: ${analyticsData.achievements.length}`, 'info');
                
                const today = new Date().toISOString().split('T')[0];
                const todayStats = analyticsData.dailyStats[today];
                if (todayStats) {
                    log(`📅 Today: ${todayStats.wordsReviewed} words, ${todayStats.accuracy}% accuracy`, 'info');
                }
                
            } catch (error) {
                log(`❌ Error testing dashboard: ${error.message}`, 'error');
            }
        }
        
        async function openAnalyticsDashboard() {
            log('Opening analytics dashboard...', 'info');
            
            // Try to open the actual analytics dashboard
            try {
                const analyticsUrl = chrome.runtime ? 
                    chrome.runtime.getURL('src/ui/analytics.html') : 
                    '../src/ui/analytics.html';
                
                window.open(analyticsUrl, '_blank');
                log('✅ Analytics dashboard opened in new tab', 'success');
                
            } catch (error) {
                log(`❌ Error opening dashboard: ${error.message}`, 'error');
                log('💡 Try manually navigating to src/ui/analytics.html', 'info');
            }
        }
        
        async function clearAll() {
            log('Clearing all data...', 'info');
            
            return new Promise(resolve => {
                chrome.storage.local.clear(() => {
                    log('✅ All data cleared', 'success');
                    resolve();
                });
            });
        }
        
        // Auto-run on page load
        document.addEventListener('DOMContentLoaded', () => {
            log('🔧 Analytics Test & Fix loaded', 'success');
            log('💡 Follow the steps above to test and fix analytics data population', 'info');
        });
    </script>
</body>
</html>
