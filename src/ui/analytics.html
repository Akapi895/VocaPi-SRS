<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocab SRS - Analytics Dashboard</title>
    <link rel="stylesheet" href="analytics.css">
    <link rel="stylesheet" href="gamification.css">
    <!-- Chart.js Optional - fallback available if not loaded -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js" onerror="console.log('Chart.js not loaded from CDN, using fallback charts')"></script>
</head>
<body>
    <div class="analytics-container">
        <!-- Gamification Section -->
        <div id="gamification-dashboard">
            <!-- Gamification content will be rendered here -->
        </div>

        <!-- Header -->
        <div class="analytics-header">
            <div class="header-left">
                <button id="back-to-main" class="btn btn-outline">
                    <span class="btn-icon">‚Üê</span> Back to Main
                </button>
            </div>
            <div class="header-center">
                <h1 class="analytics-title">
                    <span class="title-icon">üìä</span>
                    <span class="title-text">Learning Analytics</span>
                </h1>
                <p class="analytics-subtitle">Your learning journey insights</p>
            </div>
            <div class="header-right">
                <button id="refresh-analytics" class="btn btn-outline">
                    <span class="btn-icon">üîÑ</span> Refresh
                </button>
            </div>
        </div>

        <!-- Stats Overview -->
        <div class="stats-overview">
            <div class="stat-card primary">
                <div class="stat-icon">üìö</div>
                <div class="stat-content">
                    <div class="stat-number" id="total-words">0</div>
                    <div class="stat-label">Total Words Learned</div>
                </div>
            </div>
            
            <div class="stat-card success">
                <div class="stat-icon">üî•</div>
                <div class="stat-content">
                    <div class="stat-number" id="current-streak">0</div>
                    <div class="stat-label">Current Streak</div>
                </div>
            </div>
            
            <div class="stat-card warning">
                <div class="stat-icon">‚è±Ô∏è</div>
                <div class="stat-content">
                    <div class="stat-number" id="total-time">0h</div>
                    <div class="stat-label">Time Spent Learning</div>
                </div>
            </div>
            
            <div class="stat-card info">
                <div class="stat-icon">üéØ</div>
                <div class="stat-content">
                    <div class="stat-number" id="today-accuracy">0%</div>
                    <div class="stat-label">Today's Accuracy</div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-section">
            <div class="chart-container">
                <div class="chart-header">
                    <h3>üìà Weekly Progress</h3>
                    <p>Your learning activity over the past 7 days</p>
                </div>
                <canvas id="weekly-progress-chart"></canvas>
            </div>
            
            <div class="chart-container">
                <div class="chart-header">
                    <h3>üéØ Quality Distribution</h3>
                    <p>How well you're mastering new words</p>
                </div>
                <canvas id="quality-chart"></canvas>
            </div>
        </div>

        <!-- Achievements Section -->
        <div class="achievements-section">
            <div class="section-header">
                <h3>üèÜ Recent Achievements</h3>
                <div class="xp-display">
                    <span class="xp-label">Total XP:</span>
                    <span class="xp-value" id="total-xp">0</span>
                </div>
            </div>
            <div class="achievements-grid" id="achievements-grid">
                <!-- Achievements will be loaded dynamically -->
            </div>
        </div>

        <!-- Difficult Words Section -->
        <div class="difficult-words-section">
            <div class="section-header">
                <h3>‚ö†Ô∏è Words That Need More Practice</h3>
                <p>Focus on these words in your next review session</p>
            </div>
            <div class="difficult-words-list" id="difficult-words-list">
                <!-- Difficult words will be loaded dynamically -->
            </div>
        </div>

        <!-- Learning Patterns -->
        <div class="patterns-section">
            <div class="section-header">
                <h3>üìä Learning Patterns</h3>
            </div>
            <div class="patterns-grid">
                <div class="pattern-card">
                    <div class="pattern-icon">üåÖ</div>
                    <div class="pattern-content">
                        <div class="pattern-title">Best Study Time</div>
                        <div class="pattern-value" id="best-study-time">Morning</div>
                    </div>
                </div>
                
                <div class="pattern-card">
                    <div class="pattern-icon">üìÖ</div>
                    <div class="pattern-content">
                        <div class="pattern-title">Most Active Day</div>
                        <div class="pattern-value" id="most-active-day">Monday</div>
                    </div>
                </div>
                
                <div class="pattern-card">
                    <div class="pattern-icon">‚ö°</div>
                    <div class="pattern-content">
                        <div class="pattern-title">Avg. Session Length</div>
                        <div class="pattern-value" id="avg-session-length">15 min</div>
                    </div>
                </div>
                
                <div class="pattern-card">
                    <div class="pattern-icon">üéØ</div>
                    <div class="pattern-content">
                        <div class="pattern-title">Overall Accuracy</div>
                        <div class="pattern-value" id="overall-accuracy">85%</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div class="loading-state" id="loading-state">
            <div class="spinner"></div>
            <p>Loading your analytics...</p>
        </div>
        
        <!-- Error State -->
        <div class="error-state" id="error-state" style="display: none;">
            <div class="error-icon">‚ö†Ô∏è</div>
            <p id="error-message">Failed to load analytics</p>
            <button id="retry-analytics" class="btn btn-primary">Try Again</button>
        </div>
    </div>

    <script src="../utils.js"></script>
    <script>
        // Mock Chrome storage for testing in browser
        if (typeof chrome === 'undefined') {
            window.chrome = {
                storage: {
                    local: {
                        get: function(keys, callback) {
                            setTimeout(() => {
                                try {
                                    if (typeof keys === 'string') {
                                        const value = localStorage.getItem(keys);
                                        callback({ [keys]: value ? JSON.parse(value) : null });
                                    } else if (Array.isArray(keys)) {
                                        const result = {};
                                        keys.forEach(key => {
                                            const value = localStorage.getItem(key);
                                            result[key] = value ? JSON.parse(value) : null;
                                        });
                                        callback(result);
                                    } else {
                                        const result = {};
                                        for (const key of Object.keys(keys)) {
                                            const value = localStorage.getItem(key);
                                            result[key] = value ? JSON.parse(value) : keys[key];
                                        }
                                        callback(result);
                                    }
                                } catch (error) {
                                    console.error('Mock chrome storage error:', error);
                                    callback({});
                                }
                            }, 10);
                        },
                        set: function(items, callback) {
                            setTimeout(() => {
                                try {
                                    for (const [key, value] of Object.entries(items)) {
                                        localStorage.setItem(key, JSON.stringify(value));
                                    }
                                    if (callback) callback();
                                } catch (error) {
                                    console.error('Mock chrome storage set error:', error);
                                    if (callback) callback();
                                }
                            }, 10);
                        }
                    }
                }
            };
            console.log('üì¶ Mock Chrome storage initialized for Analytics');
        }
    </script>
    <script src="../analytics.js"></script>
    <script src="../gamification.js"></script>
    <script src="gamificationUI.js"></script>
    <script src="analytics.js"></script>
    <script>
        // Comprehensive initialization check
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('=== ANALYTICS PAGE DEBUG ===');
            console.log('1. DOM loaded');
            console.log('2. Chrome available:', !!window.chrome);
            console.log('3. Chrome storage available:', !!(window.chrome && window.chrome.storage));
            console.log('4. VocabAnalytics class available:', typeof VocabAnalytics !== 'undefined');
            console.log('5. VocabAnalytics instance available:', !!window.VocabAnalytics);
            
            // Force initialization
            if (typeof VocabAnalytics !== 'undefined' && !window.VocabAnalytics) {
                console.log('6. Creating VocabAnalytics instance...');
                try {
                    window.VocabAnalytics = new VocabAnalytics();
                    console.log('7. VocabAnalytics instance created successfully');
                } catch (error) {
                    console.error('7. Failed to create VocabAnalytics:', error);
                }
            }
            
            // Test chrome storage directly
            if (window.chrome && window.chrome.storage) {
                try {
                    console.log('8. Testing chrome storage...');
                    chrome.storage.local.get(['test'], (result) => {
                        if (chrome.runtime.lastError) {
                            console.error('9. Chrome storage error:', chrome.runtime.lastError);
                        } else {
                            console.log('9. Chrome storage test successful');
                        }
                    });
                } catch (error) {
                    console.error('8. Chrome storage test failed:', error);
                }
            }
        });
    </script>
</body>
</html>
